<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Skylens Weather</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
       /* For Chatbot scrollbar */
      .chatbot-messages::-webkit-scrollbar {
        width: 6px;
      }
      .chatbot-messages::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
      }
      .chatbot-messages::-webkit-scrollbar-thumb {
        background: rgba(96, 165, 250, 0.6);
        border-radius: 10px;
      }
      .chatbot-messages::-webkit-scrollbar-thumb:hover {
        background: rgba(96, 165, 250, 0.8);
      }

      @keyframes fade-in-up {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
      }
      .animate-fade-in-up {
        animation: fade-in-up 0.5s ease-out forwards;
      }
      .text-glow {
        text-shadow: 0 0 8px rgba(255, 255, 255, 0.3), 0 0 20px rgba(96, 165, 250, 0.4);
      }

      /* Mind-blowing Cosmic Background */
      html {
        height: 100%;
      }
      body {
        background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
        min-height: 100%;
        overflow-x: hidden;
      }

      @keyframes twinkle {
        0%, 100% {
          opacity: 0.2;
          transform: scale(0.95);
        }
        50% {
          opacity: 1;
          transform: scale(1.05);
        }
      }
      .animate-twinkle {
        animation: twinkle linear infinite alternate;
      }


      /* Shimmer placeholder for loading states */
      @keyframes shimmer {
        100% {
          transform: translateX(100%);
        }
      }
      .placeholder-shimmer {
        position: relative;
        overflow: hidden;
      }
      .placeholder-shimmer::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        transform: translateX(-100%);
        background-image: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0) 0,
          rgba(255, 255, 255, 0.05) 20%,
          rgba(255, 255, 255, 0.2) 60%,
          rgba(255, 255, 255, 0)
        );
        animation: shimmer 1.5s infinite;
      }

    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.22.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>
    <script type="module">
import React, { useState, useEffect, useRef } from 'react';
import ReactDOM from 'react-dom/client';
import { GoogleGenAI, Type } from "@google/genai";

// ------------------- CONSOLIDATED CODE -------------------

// 1. ICONS REPOSITORY
// All SVGs are consolidated here to avoid duplication. They accept a className prop for flexible styling.
const Icons = {
  Temperature: ({ className = "h-6 w-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 6V4m0 2v12m-4-6.5h8M8 12.5h8M8 8.5h8" /></svg>),
  WindSpeed: ({ className = "h-6 w-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M13 5l7 7-7 7M5 12h14" /></svg>),
  Precipitation: ({ className = "h-6 w-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M3 15a4 4 0 004 4h9a5 5 0 10-.25-9.98A4.002 4.002 0 0013 3a4 4 0 100 8h-1" /><path strokeLinecap="round" strokeLinejoin="round" d="M12 17l-1 2m-1-2l-1 2m4-2l1 2" /></svg>),
  Humidity: ({ className = "h-6 w-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 18.272l-5.09-5.09A7 7 0 1118.91 13.18l-5.09 5.09a1 1 0 01-1.414 0z" clipRule="evenodd" /><path strokeLinecap="round" strokeLinejoin="round" d="M12 14a2 2 0 100-4 2 2 0 000 4z" /></svg>),
  Clouds: ({ className = "h-6 w-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M3 15a4 4 0 004 4h9a5 5 0 10-.25-9.98A4.002 4.002 0 0013 3a4 4 0 100 8h-1" /></svg>),
  AirPressure: ({ className = "h-6 w-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>),
  AirQuality: ({ className = "h-6 w-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>),
  Sea: ({ className = "h-6 w-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M4 8h16M4 16h16M10 4l4 16" /><path d="M 3 12 q 4 -4 8 0 t 8 0" stroke="currentColor" strokeWidth="2" fill="none" strokeLinecap="round"/></svg>),
  SnowCover: ({ className = "h-6 w-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 2l1.09 2.22 2.22 1.09-2.22 1.09L12 8.62l-1.09-2.22-2.22-1.09 2.22-1.09L12 2zM12 22l1.09-2.22 2.22-1.09-2.22-1.09L12 15.38l-1.09 2.22-2.22 1.09 2.22 1.09L12 22zM2 12l2.22 1.09 1.09 2.22-1.09 2.22L2 12zM22 12l-2.22-1.09-1.09-2.22 1.09-2.22L22 12z" /></svg>),
  Thunderstorms: ({ className = "h-6 w-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /><path d="M 18 4 l -2 2" /><path d="M 6 18 l -2 2" /></svg>),
  WindGusts: ({ className = "h-6 w-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>),
  Search: ({ className = "h-6 w-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>),
  Chat: ({ className = "h-8 w-8" }) => (<svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>),
  Close: ({ className = "h-6 w-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>),
  Send: ({ className = "h-5 w-5" }) => (<svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>),
  Warning: ({ className = "h-6 w-6" }) => (<svg xmlns="http://www.w3.org/2000/svg" className={`${className} text-yellow-300`} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>),
};

// 2. CONSTANTS
const WEATHER_METRICS = [
  { name: 'Temperature', key: 'temperature', icon: <Icons.Temperature />, color: 'bg-orange-500' },
  { name: 'Wind speed', key: 'windSpeed', icon: <Icons.WindSpeed />, color: 'bg-cyan-500' },
  { name: 'Precipitation', key: 'precipitation', icon: <Icons.Precipitation />, color: 'bg-blue-500' },
  { name: 'Humidity', key: 'humidity', icon: <Icons.Humidity />, color: 'bg-indigo-500' },
  { name: 'Clouds', key: 'clouds', icon: <Icons.Clouds />, color: 'bg-gray-500' },
  { name: 'Air pressure', key: 'airPressure', icon: <Icons.AirPressure />, color: 'bg-pink-500' },
  { name: 'Air quality', key: 'airQuality', icon: <Icons.AirQuality />, color: 'bg-green-500' },
  { name: 'Sea', key: 'sea', icon: <Icons.Sea />, color: 'bg-teal-500' },
  { name: 'Snow cover', key: 'snowCover', icon: <Icons.SnowCover />, color: 'bg-sky-500' },
  { name: 'Thunderstorms', key: 'thunderstorms', icon: <Icons.Thunderstorms />, color: 'bg-yellow-500' },
  { name: 'Wind gusts', key: 'windGusts', icon: <Icons.WindGusts />, color: 'bg-emerald-500' },
];

// 3. GEMINI API SERVICE
const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

const fetchWeatherData = async (location) => {
  const forecastSchema = {
    type: Type.OBJECT,
    properties: {
        day: { type: Type.STRING, description: "Day of the week (e.g., 'Monday')." },
        temperature: { type: Type.STRING, description: "Forecasted high/low temperature, e.g., '22°C / 15°C'." },
        airQualityIndex: { type: Type.STRING, description: "Forecasted Air Quality Index and category, e.g., '45 (Good)'." },
        windSpeed: { type: Type.STRING, description: "Forecasted wind speed, e.g., '18 km/h'." },
        cloudiness: { type: Type.STRING, description: "A brief description of cloud cover, e.g., 'Partly Cloudy'." },
        rainfall: { type: Type.STRING, description: "The chance of rainfall as a percentage, e.g., '30%'." },
    },
    required: ["day", "temperature", "airQualityIndex", "windSpeed", "cloudiness", "rainfall"],
  };

  const weatherSchema = {
    type: Type.OBJECT,
    properties: {
        latitude: { type: Type.NUMBER, description: "The latitude of the location." },
        longitude: { type: Type.NUMBER, description: "The longitude of the location." },
        temperature: { type: Type.STRING, description: "The current temperature in Celsius, e.g., '15°C'" },
        windSpeed: { type: Type.STRING, description: "The current wind speed, e.g., '12 km/h'" },
        precipitation: { type: Type.STRING, description: "The chance of precipitation as a percentage, e.g., '10%'" },
        humidity: { type: Type.STRING, description: "The current humidity level as a percentage, e.g., '65%'" },
        clouds: { type: Type.STRING, description: "The cloud cover percentage, e.g., '75%'" },
        airPressure: { type: Type.STRING, description: "The atmospheric pressure, e.g., '1012 hPa'" },
        airQuality: { type: Type.STRING, description: "The air quality index (AQI) and category, e.g., '55 (Moderate)'" },
        sea: { type: Type.STRING, description: "Sea conditions like wave height or state, e.g., 'Slight, 0.5m waves'" },
        snowCover: { type: Type.STRING, description: "The depth of snow cover, e.g., '0 cm' or '5 cm'" },
        thunderstorms: { type: Type.STRING, description: "The probability of thunderstorms, e.g., 'Low' or 'High'" },
        windGusts: { type: Type.STRING, description: "The speed of wind gusts, e.g., '30 km/h'" },
        forecast: {
            type: Type.ARRAY,
            description: "A 7-day weather forecast.",
            items: forecastSchema,
        },
    },
    required: [
        'latitude', 'longitude', 'temperature', 'windSpeed', 'precipitation', 'humidity', 'clouds', 
        'airPressure', 'airQuality', 'sea', 'snowCover', 'thunderstorms', 'windGusts', 'forecast'
    ]
  };

  try {
    const prompt = `Provide the latitude, longitude, a realistic, detailed weather and atmospheric report, and a 7-day forecast for ${location}. Include all the required fields. For the forecast, provide the day of the week, high/low temperature, a summary of air quality, wind speed, a brief description of cloudiness (e.g., 'Sunny', 'Partly Cloudy'), and the chance of rainfall as a percentage.`;
    
    const response = await ai.models.generateContent({
        model: "gemini-2.5-flash",
        contents: prompt,
        config: {
            responseMimeType: "application/json",
            responseSchema: weatherSchema,
        },
    });

    const jsonText = response.text.trim();
    const weatherData = JSON.parse(jsonText);
    
    if (!weatherData.temperature || !weatherData.forecast || weatherData.forecast.length < 7 || weatherData.latitude === undefined || weatherData.longitude === undefined) {
        throw new Error("Invalid data structure received from API");
    }
    
    return weatherData;

  } catch (error) {
    console.error("Error fetching weather data from Gemini API:", error);
    throw new Error("Could not retrieve weather data.");
  }
};

// 4. REACT COMPONENTS

const StarfieldBackground = () => {
  const [stars, setStars] = useState([]);

  useEffect(() => {
    const generateStars = (numStars) => {
      const newStars = [];
      for (let i = 0; i < numStars; i++) {
        newStars.push({
          id: i,
          top: `${Math.random() * 100}%`,
          left: `${Math.random() * 100}%`,
          size: Math.random() * 2 + 0.5,
          animationDelay: `${Math.random() * 5}s`,
          animationDuration: `${Math.random() * 3 + 2}s`,
        });
      }
      setStars(newStars);
    };
    generateStars(150);
  }, []);

  return (
    <div className="fixed top-0 left-0 w-full h-screen z-0 pointer-events-none overflow-hidden">
      {stars.map((star) => (
        <div
          key={star.id}
          className="absolute rounded-full bg-white animate-twinkle"
          style={{
            top: star.top,
            left: star.left,
            width: `${star.size}px`,
            height: `${star.size}px`,
            animationDelay: star.animationDelay,
            animationDuration: star.animationDuration,
          }}
        />
      ))}
    </div>
  );
};

const WarningNotification = ({ message, onClose }) => {
  return (
    <div className="w-full bg-yellow-500/20 backdrop-blur-md border border-yellow-400/50 text-yellow-100 px-4 py-3 rounded-xl relative shadow-lg animate-fade-in-up" role="alert">
      <div className="flex items-center">
        <div className="py-1"><Icons.Warning /></div>
        <div>
          <p className="font-semibold ml-3">{message}</p>
        </div>
      </div>
      <button onClick={onClose} className="absolute top-2 right-2 p-1 text-yellow-200 hover:text-white rounded-full focus:outline-none focus:ring-2 focus:ring-yellow-300" aria-label="Close warning">
         <Icons.Close className="h-5 w-5" />
      </button>
    </div>
  );
};

const Header = () => (
  <header className="flex justify-between items-center w-full max-w-7xl p-4 bg-black/10 backdrop-blur-lg rounded-2xl border border-white/10 shadow-lg">
    <div className="flex items-center gap-3">
      <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/30">
        <Icons.AirQuality className="h-6 w-6 text-white" />
      </div>
      <span className="text-2xl font-bold text-white text-glow">Skylens</span>
    </div>
    <p className="hidden sm:block text-sm text-blue-200">AI-Powered Atmospheric Insights</p>
  </header>
);

const SearchBar = ({ onSearch, loading }) => {
  const [query, setQuery] = useState('');
  const handleSubmit = (e) => {
    e.preventDefault();
    if (!loading) onSearch(query);
  };

  return (
    <form onSubmit={handleSubmit} className="relative w-full">
      <div className="absolute left-4 top-1/2 -translate-y-1/2 text-blue-300">
         <Icons.Search />
      </div>
      <input
        type="text"
        value={query}
        onChange={(e) => setQuery(e.target.value)}
        placeholder="Search location... (e.g., London, Tokyo)"
        className="w-full pl-12 pr-32 py-4 bg-white/5 backdrop-blur-md text-white placeholder-blue-300 border border-white/20 rounded-full focus:ring-2 focus:ring-blue-400 focus:outline-none transition-all duration-300 shadow-lg"
        disabled={loading}
      />
      <button
        type="submit"
        className="absolute right-2 top-1/2 -translate-y-1/2 px-6 py-2.5 bg-blue-500 text-white font-semibold rounded-full hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:ring-offset-slate-900 disabled:bg-blue-400 disabled:cursor-not-allowed transition-colors"
        disabled={loading}
      >
        Search
      </button>
    </form>
  );
};

const WeatherCard = ({ metric, value, loading }) => (
  <div className="bg-black/10 backdrop-blur-xl border border-white/10 rounded-2xl p-4 sm:p-5 flex flex-col justify-between gap-4 transition-all duration-300 hover:bg-black/20 hover:border-white/20 hover:-translate-y-1 shadow-lg h-full">
    <div className="flex items-center gap-3">
      <div className={`w-10 h-10 rounded-lg flex items-center justify-center text-white ${metric.color} shadow-md`}>
        {metric.icon}
      </div>
      <p className="text-base font-semibold text-blue-100">{metric.name}</p>
    </div>
    <div>
      {loading ? (
        <div className="h-9 w-24 bg-white/5 rounded-md placeholder-shimmer" />
      ) : (
        <p className="text-3xl font-bold text-white text-glow">{value ?? '--'}</p>
      )}
    </div>
  </div>
);

const WeatherGrid = ({ weatherData, loading }) => (
  <section className="w-full">
    <h2 className="text-2xl font-bold text-white mb-6 text-glow">Current Conditions</h2>
    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-6 gap-4 sm:gap-6">
      {WEATHER_METRICS.map((metric, index) => (
        <div key={metric.key} style={{ animationDelay: `${index * 50}ms` }} className={!loading && weatherData[metric.key] !== '--' ? 'animate-fade-in-up' : ''}>
          <WeatherCard metric={metric} value={weatherData[metric.key]} loading={loading} />
        </div>
      ))}
    </div>
  </section>
);

const MapDisplay = ({ latitude, longitude, loading }) => {
  const lon_min = longitude - 0.1, lat_min = latitude - 0.1;
  const lon_max = longitude + 0.1, lat_max = latitude + 0.1;
  const mapUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${lon_min},${lat_min},${lon_max},${lat_max}&layer=mapnik&marker=${latitude},${longitude}`;

  return (
    <section className="w-full animate-fade-in-up">
      <h2 className="text-2xl font-bold text-white mb-6 text-glow">Location Map</h2>
      <div className="bg-black/10 backdrop-blur-xl border border-white/10 rounded-2xl shadow-lg overflow-hidden h-80 sm:h-96 relative">
        {loading ? (
           <div className="w-full h-full bg-white/5 placeholder-shimmer" />
        ) : (
          <iframe
            width="100%"
            height="100%"
            loading="lazy"
            src={mapUrl}
            style={{ border: 'none' }}
            title={`Map of location at latitude ${latitude}, longitude ${longitude}`}
            aria-label={`Map of location at latitude ${latitude}, longitude ${longitude}`}
          ></iframe>
        )}
      </div>
    </section>
  );
};

const ForecastTable = ({ forecast, loading }) => {
  const headers = [
    { name: 'Day', icon: null },
    { name: 'Temperature', icon: <Icons.Temperature className="h-5 w-5" /> },
    { name: 'Air Quality', icon: <Icons.AirQuality className="h-5 w-5" /> },
    { name: 'Wind', icon: <Icons.WindSpeed className="h-5 w-5" /> },
    { name: 'Clouds', icon: <Icons.Clouds className="h-5 w-5" /> },
    { name: 'Rainfall', icon: <Icons.Precipitation className="h-5 w-5" /> },
  ];

  return (
    <section className="w-full">
      <h2 className="text-2xl font-bold text-white mb-6 text-glow">7-Day Forecast</h2>
      <div className="bg-black/10 backdrop-blur-xl border border-white/10 rounded-2xl shadow-lg overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full text-left">
            <thead className="border-b border-white/10">
              <tr>
                {headers.map(header => (
                  <th key={header.name} className="p-4 text-sm font-semibold text-blue-200 uppercase tracking-wider whitespace-nowrap">
                    <div className="flex items-center gap-2">
                      {header.icon}
                      <span>{header.name}</span>
                    </div>
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              {forecast.map((day, index) => (
                <tr key={index} className={`border-b border-white/5 last:border-b-0 transition-colors hover:bg-white/5 ${!loading ? 'animate-fade-in-up' : ''}`} style={{animationDelay: `${index * 75}ms`}}>
                  <td className="p-4 font-bold text-white whitespace-nowrap">{day.day}</td>
                  {loading ? (
                    <>
                      {[...Array(5)].map((_, i) => <td key={i} className="p-4"><div className="h-5 w-24 bg-white/5 rounded placeholder-shimmer" /></td>)}
                    </>
                  ) : (
                    <>
                      <td className="p-4 text-blue-100 whitespace-nowrap">{day.temperature}</td>
                      <td className="p-4 text-blue-100 whitespace-nowrap">{day.airQualityIndex}</td>
                      <td className="p-4 text-blue-100 whitespace-nowrap">{day.windSpeed}</td>
                      <td className="p-4 text-blue-100 whitespace-nowrap">{day.cloudiness}</td>
                      <td className="p-4 text-blue-100 whitespace-nowrap">{day.rainfall}</td>
                    </>
                  )}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </section>
  );
};

const Chatbot = () => {
  const [isOpen, setIsOpen] = useState(false);
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const chatRef = useRef(null);
  const messagesEndRef = useRef(null);

  useEffect(() => {
    if (isOpen && !chatRef.current) {
        try {
            chatRef.current = ai.chats.create({
                model: 'gemini-2.5-flash',
                config: {
                    systemInstruction: "You are a friendly and knowledgeable weather assistant for the Skylens Weather app. Your knowledge base includes information from leading atmospheric science projects like NASA's SatCORPS, the BRAMS modeling system, and the Pandora Project. You provide concise and helpful answers about weather, climate, satellite imagery, cloud products, and air quality. When asked for weather in a specific location, provide a brief summary.",
                },
            });
            setMessages([{ role: 'model', text: 'Hello! How can I help you with the weather today?' }]);
        } catch (error) {
            console.error("Failed to initialize chatbot:", error);
            setMessages([{ role: 'model', text: 'Sorry, I am unable to connect right now.' }]);
        }
    }
  }, [isOpen]);
  
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  const handleSend = async () => {
    if (!input.trim() || isLoading || !chatRef.current) return;
    const userMessage = { role: 'user', text: input };
    setMessages(prev => [...prev, userMessage]);
    setInput('');
    setIsLoading(true);

    try {
        const response = await chatRef.current.sendMessage({ message: input });
        const modelMessage = { role: 'model', text: response.text };
        setMessages(prev => [...prev, modelMessage]);
    } catch (error) {
        console.error("Chatbot error:", error);
        const errorMessage = { role: 'model', text: "I'm having trouble responding right now. Please try again later." };
        setMessages(prev => [...prev, errorMessage]);
    } finally {
        setIsLoading(false);
    }
  };

  const handleKeyPress = (e) => {
    if (e.key === 'Enter') handleSend();
  };
  
  return (
    <>
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-full text-white flex items-center justify-center shadow-2xl shadow-blue-500/50 hover:scale-110 transition-transform duration-300 z-50"
        aria-label="Open weather chatbot"
      >
        <Icons.Chat />
      </button>

      {isOpen && (
        <div className="fixed bottom-24 right-6 w-[90vw] max-w-md h-[60vh] max-h-[700px] bg-slate-800/80 backdrop-blur-xl border border-white/20 rounded-2xl shadow-2xl flex flex-col z-50 transition-opacity duration-300 animate-fade-in-up">
          <header className="flex items-center justify-between p-4 border-b border-white/10">
            <h3 className="font-bold text-white text-glow">Weather Assistant</h3>
            <button onClick={() => setIsOpen(false)} className="text-blue-200 hover:text-white">
              <Icons.Close />
            </button>
          </header>
          
          <main className="flex-1 p-4 overflow-y-auto chatbot-messages">
            <div className="flex flex-col gap-4">
              {messages.map((msg, index) => (
                <div key={index} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                  <div className={`max-w-[80%] p-3 rounded-2xl text-white ${msg.role === 'user' ? 'bg-blue-600 rounded-br-none' : 'bg-slate-700 rounded-bl-none'}`}>
                    <p className="text-sm">{msg.text}</p>
                  </div>
                </div>
              ))}
              {isLoading && (
                 <div className="flex justify-start">
                   <div className="max-w-[80%] p-3 rounded-2xl bg-slate-700 rounded-bl-none text-white">
                     <div className="flex items-center gap-2">
                       <span className="h-2 w-2 bg-blue-300 rounded-full animate-pulse [animation-delay:-0.3s]"></span>
                       <span className="h-2 w-2 bg-blue-300 rounded-full animate-pulse [animation-delay:-0.15s]"></span>
                       <span className="h-2 w-2 bg-blue-300 rounded-full animate-pulse"></span>
                     </div>
                   </div>
                 </div>
              )}
               <div ref={messagesEndRef} />
            </div>
          </main>

          <footer className="p-4 border-t border-white/10">
            <div className="relative">
              <input type="text" value={input} onChange={(e) => setInput(e.target.value)} onKeyPress={handleKeyPress} placeholder="Ask about the weather..." className="w-full pl-4 pr-12 py-3 bg-slate-700 text-white placeholder-blue-300 border border-white/20 rounded-full focus:ring-2 focus:ring-blue-400 focus:outline-none transition-all duration-300" disabled={isLoading} />
              <button onClick={handleSend} disabled={isLoading || !input.trim()} className="absolute right-2 top-1/2 -translate-y-1/2 w-9 h-9 bg-blue-500 text-white rounded-full hover:bg-blue-600 disabled:bg-blue-400 disabled:cursor-not-allowed transition-colors flex items-center justify-center">
                 <Icons.Send />
              </button>
            </div>
          </footer>
        </div>
      )}
    </>
  );
};

// 5. MAIN APP COMPONENT
const App = () => {
  const defaultForecast = [...Array(7)].map((_, i) => {
    const d = new Date();
    d.setDate(d.getDate() + i);
    return {
        day: d.toLocaleDateString('en-US', { weekday: 'long' }),
        temperature: '--', airQualityIndex: '--', windSpeed: '--', cloudiness: '--', rainfall: '--',
    };
  });
  const defaultWeatherData = {
    temperature: '--', windSpeed: '--', precipitation: '--', humidity: '--', clouds: '--', airPressure: '--',
    airQuality: '--', sea: '--', snowCover: '--', thunderstorms: '--', windGusts: '--',
    forecast: defaultForecast, latitude: 20, longitude: 0,
  };

  const [weatherData, setWeatherData] = useState(defaultWeatherData);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [location, setLocation] = useState('');
  const [warnings, setWarnings] = useState([]);

  const checkForWarnings = (data) => {
    const alerts = new Set();
    const aqiRegex = /(\d+)/;
    if (data.airQuality && data.airQuality !== '--') {
        const match = data.airQuality.match(aqiRegex);
        if (match && parseInt(match[0], 10) > 100) alerts.add(`Air Quality Alert: Current conditions are unhealthy for sensitive groups (${data.airQuality}).`);
    }
    if (data.thunderstorms && (data.thunderstorms.toLowerCase().includes('high') || data.thunderstorms.toLowerCase().includes('likely'))) {
        alerts.add(`Severe Weather Alert: High probability of thunderstorms currently.`);
    }
    data.forecast?.forEach(day => {
        if (day.airQualityIndex && day.airQualityIndex !== '--') {
            const match = day.airQualityIndex.match(aqiRegex);
            if (match && parseInt(match[0], 10) > 100) alerts.add(`Air Quality Watch: Unhealthy conditions expected in the coming days.`);
        }
        if (day.cloudiness && (day.cloudiness.toLowerCase().includes('thunderstorm') || day.cloudiness.toLowerCase().includes('heavy rain'))) {
            alerts.add(`Severe Weather Watch: Potential for thunderstorms or heavy rain on ${day.day}.`);
        }
    });
    return Array.from(alerts);
  };

  const handleSearch = async (query) => {
    if (!query) return;
    setLoading(true);
    setError(null);
    setLocation(query);
    setWarnings([]);

    try {
      const data = await fetchWeatherData(query);
      setWeatherData(data);
      setWarnings(checkForWarnings(data));
    } catch (err) {
      setError('Failed to fetch weather data. The location might be invalid or there was a network issue. Please try again.');
      setWeatherData({ ...defaultWeatherData, latitude: 0, longitude: 0 });
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="relative min-h-screen w-full overflow-x-hidden text-white font-sans">
      <StarfieldBackground />
      <main className="relative z-10 flex flex-col items-center w-full min-h-screen p-4 sm:p-6 lg:p-8">
        <Header />
        <div className="w-full max-w-4xl mt-8 space-y-3 z-20">
            {warnings.map((warning, index) => (
            <WarningNotification key={index} message={warning} onClose={() => setWarnings(prev => prev.filter((_, i) => i !== index))} />
            ))}
        </div>
        <div className="flex flex-col items-center justify-center w-full max-w-4xl mt-8 text-center">
            <h1 className="text-4xl sm:text-5xl md:text-6xl font-bold text-white text-glow bg-gradient-to-r from-blue-300 via-white to-cyan-300 text-transparent bg-clip-text">
                Atmospheric Insights, Instantly
            </h1>
            <p className="mt-4 text-lg text-blue-200 max-w-2xl">
                Enter any location to get a detailed, AI-powered weather and atmospheric analysis, including a 7-day forecast.
            </p>
        </div>
        <div className="w-full max-w-2xl mt-12">
          <SearchBar onSearch={handleSearch} loading={loading} />
        </div>
        <div className="w-full max-w-6xl mt-12 space-y-12">
          {loading && (
            <div className="flex flex-col items-center justify-center p-8 text-center">
                <div className="w-16 h-16 border-4 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
                <p className="mt-4 text-lg text-blue-200">Analyzing conditions for {location}...</p>
            </div>
          )}
          {error && <p className="text-center text-red-400 bg-red-900/50 p-4 rounded-lg">{error}</p>}
          <>
            <WeatherGrid weatherData={weatherData} loading={loading} />
            {location && !error && (
              <MapDisplay latitude={weatherData.latitude} longitude={weatherData.longitude} loading={loading} />
            )}
            <ForecastTable forecast={weatherData.forecast} loading={loading} />
          </>
        </div>
        <footer className="w-full max-w-6xl mt-16 mb-8 text-center text-blue-300/70">
            <p>&copy; {new Date().getFullYear()} Skylens Weather. All rights reserved.</p>
        </footer>
        <Chatbot />
      </main>
    </div>
  );
};


// 6. RENDER THE APP
const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}
const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
    </script>
  </body>
</html>
